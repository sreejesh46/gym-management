<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Diet Plans - Member</title>
    <link rel="stylesheet" href="sdb.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Matangi:wght@300..900&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <style>
      .diet-container {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 1rem;
        margin-top: 2rem;
      }

      .diet-card {
        background: #2e2e2e;
        border-radius: 10px;
        padding: 1rem;
        box-shadow: 0 0 5px #00ff88;
        position: relative;
        overflow: hidden;
      }

      .diet-card.blurred {
        filter: blur(3px) grayscale(0.7);
        pointer-events: none;
      }

      .lock-overlay {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(30, 30, 30, 0.7);
        border-radius: 50%;
        padding: 18px;
        z-index: 2;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .lock-overlay i {
        color: #ff4d4d;
        font-size: 2.2rem;
      }

      .diet-card h3 {
        color: #00ff88;
        margin-bottom: 0.5rem;
      }

      .diet-card p {
        font-size: 0.9rem;
      }

      .diet-card img {
        width: 100%;
        height: 150px;
        object-fit: cover;
        border-radius: 8px;
        margin: 0.5rem 0;
      }
    </style>
  </head>
  <body>
    <div class="sidebar">
      <h2>Member Panel</h2>
      <a href="member-dashboard.html"><i class="fas fa-home"></i> Dashboard</a>
      <a href="view-bills.html"
        ><i class="fas fa-file-invoice"></i> View Bills</a
      >
      <a href="diet-plan.html"><i class="fas fa-utensils"></i> Diet Plan</a>
      <a href="supplements.html"><i class="fas fa-capsules"></i> Supplements</a>
      <a href="index.html"><i class="fas fa-sign-out-alt"></i> Logout</a>
    </div>

    <div class="main">
      <h1>Diet Plans</h1>
      <div class="diet-container" id="dietList"></div>

      <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import {
          getFirestore,
          collection,
          getDocs,
        } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

        const firebaseConfig = {
          apiKey: "AIzaSyDoiS09B_JD21g60sVV1eYInCVdQOqxv7k",
          authDomain: "gym-management-system-540ea.firebaseapp.com",
          projectId: "gym-management-system-540ea",
          storageBucket: "gym-management-system-540ea.appspot.com",
          messagingSenderId: "368679749818",
          appId: "1:368679749818:web:21a7f5909db550aa5d1a83",
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const dietList = document.getElementById("dietList");

        // Get member package from Firestore
        import {
          getAuth,
          onAuthStateChanged,
        } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
        import {
          doc,
          getDoc,
        } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

        async function getMemberPackage() {
          const auth = getAuth(app);
          return new Promise((resolve) => {
            onAuthStateChanged(auth, async (user) => {
              if (user) {
                const userDoc = await getDoc(doc(db, "members", user.uid));
                if (userDoc.exists()) {
                  const member = userDoc.data();
                  resolve((member.package || "").toLowerCase());
                } else {
                  resolve("");
                }
              } else {
                resolve("");
              }
            });
          });
        }

        let dietPlansRendered = false;
        async function enforceDietLock() {
          if (dietPlansRendered) return;
          dietPlansRendered = true;
          dietList.innerHTML = "";
          const memberPackage = await getMemberPackage();
          const snapshot = await getDocs(collection(db, "dietPlans"));
          snapshot.forEach((doc) => {
            const data = doc.data();
            const div = document.createElement("div");
            div.className = "diet-card";
            div.innerHTML = `
            <h3>${data.title}</h3>
            <p><strong>Audience:</strong> ${data.audience}</p>
            <p><strong>Breakfast:</strong> ${data.breakfast}</p>
            <p><strong>Lunch:</strong> ${data.lunch}</p>
            <p><strong>Dinner:</strong> ${data.dinner}</p>
            <p><strong>Snacks:</strong> ${data.snacks}</p>
            ${
              data.image
                ? `<img src="${data.image}" alt="${data.title} Image">`
                : ""
            }
          `;
            if (memberPackage.includes("basic")) {
              div.classList.add("blurred");
              const lock = document.createElement("div");
              lock.className = "lock-overlay";
              lock.innerHTML = '<i class="fas fa-lock"></i>';
              div.appendChild(lock);
            }
            dietList.appendChild(div);
          });
        }

        // Always enforce lock on page load and after navigation
        window.addEventListener("DOMContentLoaded", enforceDietLock);
        window.addEventListener("pageshow", enforceDietLock);
      </script>
    </div>
  </body>
</html>
